<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
    <title> Gantt Proposal</title>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="bulmaStyles.css">
    <link rel="stylesheet" href="ganttStyle.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script> 
    
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="ganttChart.js"></script>
    <script type="text/javascript" src="ganttHelper.js"></script>
    
</head>

<body>
    <nav class="navbar is-warning" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://gptool.com">
                <h1 class="title has-text-centered">
                        GP
                </h1>
            </a>
        </div>
        <h3 class="title is-5 has-text-centered searchbar">
    </nav>
    <br>
    <!-- Main container -->    
    <br>

    <div class="columns is-vcentered">
        <div class="column is-offset-1">
            <label for="url">GitHub user/repo URL:</label>
            <input type="url" name="giturl" id="giturl"
                placeholder=" tensorflow/tensorflow" size="60"
                required> <br>
            <button id="btnIssues">Issues</button>
            <button id="btnCommits">Commits</button>
            <div id="divResult">

            </div>
        </div>
    </div>

    <div class="columns is-vcentered">
        <div class="column is-offset-1">
            <span class="tag is-primary is-light horizontalLabel" id="chartLabel">SPRINTS</span>
            <div class="box gantt">  
                <a id="r" style="width:50px; position: absolute; z-index: 100" onclick="resetGantt()"><img src='/return.svg' alt="Go back"></a>
                <div class="field is-grouped is-grouped-right">                    
                    <button class="button is-small" onclick="changeTimeDomain('1day')">DAY</button>
                    <button class="button is-small" onclick="changeTimeDomain('thisWeek')">WEEK</button>                    
                    <button class="button is-small" onclick="changeTimeDomain('1month')">MONTH</button>
                    <button class="button is-small" onclick="changeTimeDomain('lastTask')">LAST</button>
                </div>
                <div id="ganttChart"></div>
            </div>

        </div>

        <div class="column">
            <span class="tag is-primary is-light horizontalLabel">Task</span>
            <div class="box form">
                <form id="ganttForm">

                    <div class="field is-grouped">
                        <div class="field" style="margin-right: 12px">
                            <label class="label">Name</label>
                            <div class="control">
                                <input id="taskName" name="taskName" class="input " type="text" placeholder="001 - Name">
                            </div>
                        </div>
    
                        <div class="field px-6">
                            <label class="label">Team</label>
                            <div class="control">
                                <div class="select">
                                <select name="taskGroup" id="taskGroup">
                                    <option>Team 1</option>
                                    <option>Team 2</option>
                                    <option>Team 3</option>
                                    <option>Team 4</option>
                                    <option>Team 5</option>
                                </select>
                                </div>
                            </div>
                        </div>
                    </div>                   

                    <div class="field is-grouped">
                        <div class="field is-horizontal">
                            <div class="field" style="margin-right: 12px">
                                <label class="label">Start Date</label>
                                <div class="control">
                                    <input type="date" id="taskStart" name="taskStart">
                                </div>
                            </div>                           

                            <div class="field ">
                                <label class="label">End Date</label>
                                <div class="control">
                                    <input type="date" id="taskFinish" name="taskFinish">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field is-grouped is-grouped-left">
                        <div class="field" style="margin-right: 12px">
                            <label class="label">Type</label>
                            <div class="control">
                                <div class="select">
                                <select id="taskType" name="taskType">
                                    <option>Backend</option>
                                    <option>Frontend</option>
                                    <option>API</option>
                                </select>
                                </div>
                            </div>
                        </div> 

                        <div class="field">
                            <label class="label">Estimative</label>
                            <div class="control">
                                <input class="input"  id="taskEstimative" name="taskEstimative"  type="number" placeholder="30"  style="width:4em;" >
                            </div>
                        </div>                        
                    </div>                        

                    <div class="field">
                        <label class="label">Description</label>
                        <div class="field-body">
                            <div class="field">
                            <div class="control">
                                <textarea class="textarea" id="taskDescription" name="taskDescription" placeholder="Breve descrição da tarefa"></textarea>
                            </div>
                            </div>
                        </div>
                    </div>


                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-success">Add Task</button>
                        </div>
                        <div class="control">
                            <button class="button is-link is-danger">Remove Task</button>
                        </div>
                    </div>

                </form>       
            </div>
        </div>
    </div>
    


    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>Gantt Proposal</strong>
            </p>
            <p>
                <strong>Eduardo • Gabriel • Rafael • Vinicius</strong>
            </p>
        </div>
    </footer>

    <script>
       
        gantt(CURRENT_TASKS)  

        $('#ganttForm').submit(function(e) {
            e.preventDefault();
            
            var values = []
            $.each($('#ganttForm').serializeArray(), function(i, field) {
                values[field.name] = field.value;
            });

            console.log(values)
                        
            //TODO: ADICIONAR LIMITAÇÃO AO DAR O SUBMIT - CAMPOS OBRIGATORIOS
            //TODO: ADICIONAR OPÇÃO DE 'SELECIONAR' TAREFA/SPRINT
            //TODO: ADICIONAR FLUXO DE REMOÇÃO 
            //removeTask(e)
            addTask(values)

        });

        var btnIssues = document.getElementById("btnIssues")
        const btnCommits = document.getElementById("btnCommits")
        const divResult = document.getElementById("divResult")
        btnIssues.addEventListener("click", getIssues)
        btnCommits.addEventListener("click", e => getCommits())
        function clear() {
            while (divResult.firstChild)
                divResult.removeChild(divResult.firstChild)
        }

        async function getIssues() {
            clear();
            var url = "https://api.github.com/search/issues?q=repo:"
            
            // var repo = document.getElementById("giturl").value;
            var repo = "junit-team/junit5";

            url = url.concat(repo, " type:issue ");
            const response = await fetch(url)
            const result = await response.json()
            var count = 0;

            var resultFiltered = result.items.filter(item => item.milestone);
            var users = resultFiltered.map(item => item.user.login);

            var subTasks = [];

            console.log(resultFiltered);
            console.log(users);

            var id = 1;
            var count = 1;

            var Startdates = resultFiltered.map(r => r.created_at);
            var EndDates = resultFiltered.map(r => r.closed_at);

            var minDate = Startdates.reduce(function (a, b) { return a < b ? a : b; }); 
            var maxDate = EndDates.reduce(function (a, b) { return a > b ? a : b; });

            var IdsMilestones = resultFiltered.map(r => r.milestone.id);
            var IdsMilestonesFiltered = IdsMilestones.filter(function(elem, index, array) { return array.indexOf(elem) === index });

            var milestones = resultFiltered.map(r => r.milestone);

            var milestonesFiltered = [];
            var listAux = []
            for(var j = 0; j < milestones.length; j++)
            {
                if(IdsMilestonesFiltered.indexOf(milestones[j].id) >= 0 && milestonesFiltered && listAux.indexOf(milestones[j].id) < 0)
                {
                    milestonesFiltered.push(milestones[j]);
                    listAux.push(milestones[j].id);
                }
            }

            taskGroups = []
            milestonesFiltered.forEach(item => {

                var taskGroup = "Team " + count;
                var mainTask =
                    {
                        "isSubtask": false,
                        "taskName": item.title,
                        "id": id++,
                        "startDate": new Date(),
                        "endDate": new Date(),
                        "taskGroup": taskGroup,
                        "status": item.state == "open" ? taskStatus.RUNNING : taskStatus.SUCCEEDED,
                        "taskDescription": item.description,
                        "taskType": undefined,
                        "subTasks": []
                    };

                count++;
                taskGroups.push(taskGroup)

                var currentId = 0;
                subtaskGroups = []

                resultFiltered.forEach(i => {
                    
                    if(item.id === i.milestone.id)
                    {
                        const anchor = document.createElement("a")
                        anchor.href = i.html_url;
                        // anchor.textContent = i.title.concat(" ", count);
                        // divResult.appendChild(anchor)
                        // var info = "    ";
                        // info = info.concat("Descrição: ", i.body, "| Data estimada: ", i.due_on);
                        // info = info.concat("|    Cirado em: ", i.created_at, "|   fechado em:", i.closed_at)
                        // divResult.appendChild(document.createTextNode(info))
                        // divResult.appendChild(document.createElement("br"))

                        var taskName = i.title;
                        var taskDescription = i.body;
                        var startDate = new Date(i.created_at);
                        var endDate = new Date(i.closed_at);
                        var taskTime = i.due_on;
                        var taskGroup = i.user.login

                        subtaskGroups.push(taskGroup);

                        var labels = i.labels
                        // console.log(labels)
                        
                        var taskType;
                        labels.forEach(element => {
                            labelName = element.name.toLowerCase();

                            if(labelName.includes("add")) {
                                taskType = "Add";
                            }
                            else if(labelName.includes("bug")) {
                                taskType = "Bug";
                            }
                            else if(labelName.includes("change")) {
                                taskType = "Change";
                            }
                            else if(labelName.includes("file")) {
                                taskType = "File";
                            }
                            else if(labelName.includes("fix")) {
                                taskType = "Fix";
                            }
                            else if(labelName.includes("new")) {
                                taskType = "New";
                            }
                            else if(labelName.includes("patch")) {
                                taskType = "Patch";
                            }
                            else if(labelName.includes("support")) {
                                taskType = "Support";
                            }
                            else if(labelName.includes("test")) {
                                taskType = "Test";
                            } 
                            else {
                                taskType = undefined;
                            }
                        });

                        mainTask.subTasks.push({
                            "isSubtask": true,
                            "taskName" : taskName,
                            "id": currentId++,
                            "startDate" : startDate,
                            "endDate" : endDate,
                            "taskGroup" : taskGroup,
                            "status" : taskStatus.RUNNING,
                            "taskDescription": taskDescription,
                            "taskType": taskType,
                            "subTasks":[]
                        })
                    }
                })

                var StartdatesSubTasks = mainTask.subTasks.map(s => s.startDate);
                var EndDatesSubTasks = mainTask.subTasks.map(s => s.endDate);

                var minDateSubTasks = StartdatesSubTasks.reduce(function (a, b) { return a < b ? a : b; });
                var maxDateSubTasks = EndDatesSubTasks.reduce(function (a, b) { return a > b ? a : b; });

                mainTask.startDate = new Date(minDateSubTasks);
                mainTask.endDate = new Date(maxDateSubTasks);

                MAIN_TASKS.push(mainTask);
            })

            changeTimeDomain("1year");
            maingantt = d3.gantt().taskTypes(taskGroups).taskStatus(taskStatus).tickFormat(format);
            subgantt = d3.gantt().taskTypes(subtaskGroups).taskStatus(taskStatus).tickFormat(format);

            maingantt.timeDomainMode("fit");
            subgantt.timeDomainMode("fit");

            gantt = maingantt;

            CURRENT_TASKS = MAIN_TASKS;

            console.log(CURRENT_TASKS);
            gantt.redraw(CURRENT_TASKS);
        }

        async function getCommits() {
            clear();
            var url = "https://api.github.com/search/commits?q=repo:"
            url = url.concat(document.getElementById("giturl").value, " author-date:2019-03-01..2019-03-31")
            
            const headers = {
                "Accept": "application/vnd.github.cloak-preview"
            }
        
            const response = await fetch(url, {
                "method": "GET",
                "headers": headers
            })
            //"<https://api.github.com/search/commits?q=repo%3Afreecodecamp%2Ffreecodecamp+author-date%3A2019-03-01..2019-03-31&page=2>; rel="next", <https://api.github.com/search/commits?q=repo%3Afreecodecamp%2Ffreecodecamp+author-date%3A2019-03-01..2019-03-31&page=27>; rel="last""

            const link = response.headers.get("link")
            const links = link.split(",")
            const urls = links.map(a => {
                return {
                    url: a.split(";")[0].replace(">", "").replace("<", ""),
                    title: a.split(";")[1]
                }

            })
            const result = await response.json()

            console.log(result);

            result.items.forEach(i => {
                const img = document.createElement("img")
                img.src = i.author.avatar_url;
                img.style.width = "32px"
                img.style.height = "32px"
                const anchor = document.createElement("a")
                anchor.href = i.html_url;
                anchor.textContent = i.commit.message.substr(0, 120) + "...";
                divResult.appendChild(img)
                divResult.appendChild(anchor)
                divResult.appendChild(document.createElement("br"))


            })


            urls.forEach(u => {
                const btn = document.createElement("button")
                btn.textContent = u.title;
                btn.addEventListener("click", e => getCommits(u.url))
                divResult.appendChild(btn);
            })

        }
        
    </script>
</body>

</html>