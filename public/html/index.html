<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
    <title> Gantt Proposal</title>

    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="bulmaStyles.css">
    <link rel="stylesheet" href="ganttStyle.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script> 
    
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="ganttChart.js"></script>
    <script type="text/javascript" src="ganttHelper.js"></script>
    

</head>

<body>
    <nav class="navbar is-warning" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://gptool.com">
                <h1 class="title has-text-centered">
                        GP
                </h1>
            </a>
        </div>
        <h3 class="title is-5 has-text-centered searchbar">
    </nav>
    <br>
    <!-- Main container -->    
    <br>

    <div class="columns is-vcentered">
        <div class="column is-offset-1">
            <label for="url">Entre com o repositório GitHub user/repo URL:</label>
            <input type="url" name="giturl" id="giturl"
                placeholder=" tensorflow/tensorflow" size="60"
                required> <br>
            <button id="btnIssues">Issues</button>
            <button id="btnCommits">Commits</button>
            <div id="divResult">

            </div>
        </div>
    </div>

    <div class="columns is-vcentered">
        <div class="column is-offset-1">
            <span class="tag is-primary is-light horizontalLabel">Sprints</span>
            <div class="box gantt">  
                <a id="r" style="width:50px; position: absolute; z-index: 100" onclick="resetGantt()"><img src='/return.svg' alt="Go back"></a>
                <div class="field is-grouped is-grouped-right">                    
                    <button class="button is-small" onclick="changeTimeDomain('1day')">DAY</button>
                    <button class="button is-small" onclick="changeTimeDomain('1week')">WEEK</button>
                </div>
                <div id="ganttChart"></div>
            </div>

        </div>

        <div class="column">
            <span class="tag is-primary is-light horizontalLabel">Task</span>
            <div class="box form">
                <form id="ganttForm">

                    <div class="field is-grouped">
                        <div class="field" style="margin-right: 12px">
                            <label class="label">Nome</label>
                            <div class="control">
                                <input id="taskName" name="taskName" class="input " type="text" placeholder="XXX - Adicionar nome">
                            </div>
                        </div>
    
                        <div class="field px-6">
                            <label class="label">Time</label>
                            <div class="control">
                                <div class="select">
                                <select name="taskGroup" id="taskGroup">
                                    <option>Team 1</option>
                                    <option>Team 2</option>
                                    <option>Team 3</option>
                                    <option>Team 4</option>
                                    <option>Team 5</option>
                                </select>
                                </div>
                            </div>
                        </div>
                    </div>                   

                    <div class="field is-grouped">
                        <div class="field is-horizontal">
                            <div class="field" style="margin-right: 12px">
                                <label class="label">Data de Inicio</label>
                                <div class="control">
                                    <input type="date" id="taskStart" name="taskStart">
                                </div>
                            </div>                           

                            <div class="field ">
                                <label class="label">Data de Fim</label>
                                <div class="control">
                                    <input type="date" id="taskFinish" name="taskFinish">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field is-grouped is-grouped-left">
                        <div class="field" style="margin-right: 12px">
                            <label class="label">Tipo</label>
                            <div class="control">
                                <div class="select">
                                <select id="taskType" name="taskType">
                                    <option>Backend</option>
                                    <option>Frontend</option>
                                    <option>API</option>
                                </select>
                                </div>
                            </div>
                        </div> 

                        <div class="field">
                            <label class="label">Estimativa</label>
                            <div class="control">
                                <input class="input"  id="taskEstimative" name="taskEstimative"  type="number" placeholder="30"  style="width:4em;" >
                            </div>
                        </div>                        
                    </div>                        

                    <div class="field">
                        <label class="label">Descrição</label>
                        <div class="field-body">
                            <div class="field">
                            <div class="control">
                                <textarea class="textarea" id="taskDescription" name="taskDescription" placeholder="Breve descrição da tarefa"></textarea>
                            </div>
                            </div>
                        </div>
                    </div>


                    <div class="field is-grouped">
                        <div class="control">
                            <button class="button is-success">Add task</button>
                        </div>
                        <div class="control">
                            <button class="button is-link is-danger">Remove Task</button>
                        </div>
                    </div>

                </form>       
            </div>
        </div>
    </div>
    


    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>Gantt Proposal</strong>
            </p>
            <p>
                <strong>Eduardo • Gabriel • Rafael • Vinicius</strong>
            </p>
        </div>
    </footer>

    <script>
        var btnIssues = document.getElementById("btnIssues")
        const btnCommits = document.getElementById("btnCommits")
        const divResult = document.getElementById("divResult")
        btnIssues.addEventListener("click", getIssues)
        btnCommits.addEventListener("click", e => getCommits())
        function clear() {
            while (divResult.firstChild)
                divResult.removeChild(divResult.firstChild)
        }

        async function getIssues() {
            clear();
            var url = "https://api.github.com/search/issues?q=repo:"
            url = url.concat(document.getElementById("giturl").value, " type:issue state:closed");
            const response = await fetch(url)
            const result = await response.json()
            var count = 0;

            console.log(result)

            result.items.forEach(i => {
                count++;
                const anchor = document.createElement("a")
                anchor.href = i.html_url;
                // anchor.textContent = i.title.concat(" ", count);
                // divResult.appendChild(anchor)
                // var info = "    ";
                // info = info.concat("Descrição: ", i.body, "| Data estimada: ", i.due_on);
                // info = info.concat("|    Cirado em: ", i.created_at, "|   fechado em:", i.closed_at)
                // divResult.appendChild(document.createTextNode(info))
                // divResult.appendChild(document.createElement("br"))

                var taskName = i.body
                var taskDescription = "teste"
                var startDate = new Date(i.created_at);
                var endDate = new Date(i.closed_at);
                var taskTime = i.due_on
                var taskGroup = "group"
                var taskType = "BUG"

                CURRENT_TASKS.push({
                    "isSubtask":true,
                    "taskName" : taskName,
                    "id": currentId++,
                    "startDate" : startDate,
                    "endDate" : endDate,
                    "taskGroup" : taskGroup,
                    "status" : taskStatus.RUNNING,
                    "taskDescription": taskDescription,
                    "taskType": taskType,
                    "subTasks":[]
                })

            })

            console.log(CURRENT_TASKS)
        }

        async function getCommits() {
            clear();
            var url = "https://api.github.com/search/commits?q=repo:"
            url = url.concat(document.getElementById("giturl").value, " author-date:2019-03-01..2019-03-31")
            
            const headers = {
                "Accept": "application/vnd.github.cloak-preview"
            }
        
            const response = await fetch(url, {
                "method": "GET",
                "headers": headers
            })
            //"<https://api.github.com/search/commits?q=repo%3Afreecodecamp%2Ffreecodecamp+author-date%3A2019-03-01..2019-03-31&page=2>; rel="next", <https://api.github.com/search/commits?q=repo%3Afreecodecamp%2Ffreecodecamp+author-date%3A2019-03-01..2019-03-31&page=27>; rel="last""

            const link = response.headers.get("link")
            const links = link.split(",")
            const urls = links.map(a => {
                return {
                    url: a.split(";")[0].replace(">", "").replace("<", ""),
                    title: a.split(";")[1]
                }

            })
            const result = await response.json()

            result.items.forEach(i => {
                const img = document.createElement("img")
                img.src = i.author.avatar_url;
                img.style.width = "32px"
                img.style.height = "32px"
                const anchor = document.createElement("a")
                anchor.href = i.html_url;
                anchor.textContent = i.commit.message.substr(0, 120) + "...";
                divResult.appendChild(img)
                divResult.appendChild(anchor)
                divResult.appendChild(document.createElement("br"))


            })


            urls.forEach(u => {
                const btn = document.createElement("button")
                btn.textContent = u.title;
                btn.addEventListener("click", e => getCommits(u.url))
                divResult.appendChild(btn);
            })

        }

       

        gantt(CURRENT_TASKS)  

        $('#ganttForm').submit(function(e) {
            e.preventDefault();
            
            var values = []
            $.each($('#ganttForm').serializeArray(), function(i, field) {
                values[field.name] = field.value;
            });

            console.log(values)
                        
            //TODO: ADICIONAR LIMITAÇÃO AO DAR O SUBMIT - CAMPOS OBRIGATORIOS
            //TODO: ADICIONAR OPÇÃO DE 'SELECIONAR' TAREFA/SPRINT
            //TODO: ADICIONAR FLUXO DE REMOÇÃO 
            //removeTask(e)
            addTask(values)

        });

    </script>
</body>

</html>